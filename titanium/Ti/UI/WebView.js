define(["Ti/_/declare","Ti/_/UI/Widget","Ti/_/dom","Ti/_/event","Ti/_/lang","Ti/_/text!Ti/_/UI/WebViewBridge.js","Ti/App","Ti/API","Ti/UI"],function(t,e,i,n,r,o,a,s,c){var l=require.on;return t("Ti.UI.WebView",e,{constructor:function(){a.addEventListener(this.widgetId+":unload",r.hitch(this,function(){this._loading(1)})),this.backgroundColor="#fff"},destroy:function(){a.removeEventListener(this.widgetId+":unload"),this._destroy(),e.prototype.destroy.apply(this,arguments)},_destroy:function(){this._iframe&&(n.off(this._iframeHandles),i.destroy(this._iframe))},_createIFrame:function(){if(this._parent){this._destroy(),this._loading(1);var t=this.url||"",e=t.match(/(https?)\:\/\/([^\:\/]*)(:?\d*)(.*)/),n=window.location,r=!e||e[0]+":"===n.protocol&&e[1]+e[2]===window.location.host,a=this._iframe=i.create("iframe",{frameborder:0,marginwidth:0,marginheight:0,hspace:0,vspace:0,scrolling:this.showScrollbars?"auto":"no",src:t||require.toUrl("Ti/_/UI/blank.html"),style:{width:"100%",height:"100%"}},this.domNode);return this._iframeHandles=[l(a,"load",this,function(){var t,e,i,n=Math.max(0|r,0),c=a.contentWindow;if(-1!==n)r=-1;else for(t in c){n++;break}n>0?(e=c.location.href,this.evalJS(o.replace("WEBVIEW_ID",this.widgetId+":unload")),(i=this.properties.__values__.html)&&this._setContent(i)):s.warn("Unable to inject WebView bridge into cross-domain URL, ignore browser security message"),this._loading(),this.fireEvent("load",{url:e?this.properties.__values__.url=e:this.url})}),l(a,"error",this,function(){this._loading(),this.fireEvent("error",{message:"Page failed to load",url:this.url})})],1}},_setParent:function(){e.prototype._setParent.apply(this,arguments),(this.url||this.html)&&this._createIFrame()},_getWindow:function(){return this._iframe.contentWindow},_getDoc:function(){return this._getWindow().document},_getHistory:function(){return this._getWindow().history},_loading:function(t){this.loading||t&&this.fireEvent("beforeload",{url:this.url}),this.constants.loading=!!t},canGoBack:function(){return this.url&&!!this._getHistory().length},canGoForward:function(){return this.url&&!!this._getHistory().length},evalJS:function(t){var e=this._getWindow(),i=null;try{i=t&&e&&e.eval&&e.eval(t)}catch(n){}return i},goBack:function(){if(this.canGoBack()){var t=this._getHistory();t&&(this._loading(1),t.go(-1))}},goForward:function(){if(this.canGoForward()){var t=this._getHistory();t&&(this._loading(1),t.go(1))}},reload:function(){var t=this._getWindow();this.url&&t?t.location.href=this.url:this._createIFrame()},stopLoading:function(t){try{this.loading&&t?this._destroy():this._getWindow().stop()}catch(e){}this._loading()},_defaultWidth:c.FILL,_defaultHeight:c.FILL,_getContentSize:function(){return{width:this._iframe?this._iframe.clientWidth:0,height:this._iframe?this._iframe.clientHeight:0}},_setContent:function(t){try{var e=this._getDoc();e.open(),e.write(t),e.close()}catch(i){}return t},properties:{data:{set:function(t){var e=t;switch(e&&e.declaredClass){case"Ti.Filesystem.File":e=e.read();case"Ti.Blob":e=""+e;default:this.html=e}return t}},html:{get:function(t){var e=this._iframe&&this._getDoc();return void 0===t&&e?e.documentElement.innerHTML:t},post:function(t){var e=this.properties.__values__;e.data=void 0,e.url=void 0,this._createIFrame()&&this._setContent(t)}},showScrollbars:{set:function(t){return this._iframe&&i.attr.set(this._iframe,"scrolling",t?"auto":"no"),t},value:!0},url:{post:function(){var t=this.properties.__values__;t.data=void 0,t.html=void 0,this._createIFrame()}}},constants:{loading:!1}})});