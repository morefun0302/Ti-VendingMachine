define(["Ti/_/declare","Ti/_/UI/KineticScrollView","Ti/_/style","Ti/_/lang","Ti/UI/MobileWeb/TableViewSeparatorStyle","Ti/UI"],function(t,e,i,n,r,o){var a=i.set,s=require.is,c=n.isDef,l=.001,u=/(click|singletap|longpress)/;return t("Ti.UI.TableView",e,{constructor:function(){var t;this._initKineticScrollView(t=o.createView({width:o.INHERIT,height:o.SIZE,left:0,top:0,layout:o._LAYOUT_CONSTRAINING_VERTICAL}),"vertical","vertical",1),t._add(this._header=o.createView({height:o.SIZE,width:o.INHERIT,layout:o._LAYOUT_CONSTRAINING_VERTICAL})),t._add(this._sections=o.createView({height:o.SIZE,width:o.INHERIT,layout:o._LAYOUT_CONSTRAINING_VERTICAL})),t._add(this._footer=o.createView({height:o.SIZE,width:o.INHERIT,layout:o._LAYOUT_CONSTRAINING_VERTICAL})),this.data=[],this.constants.__values__.sections=[]},_handleMouseWheel:function(){this._fireScrollEvent("scroll")},_handleDragStart:function(){this.fireEvent("dragstart")},_handleDrag:function(t){this._fireScrollEvent("scroll",t)},_handleDragEnd:function(t,e,i){var n=this;if(c(i)){var r=i*i/(1.724*l)*(0>i?-1:1),a=Math.abs(i)/l,s=Math.min(0,Math.max(n._minTranslationY,n._currentTranslationY+r));n.fireEvent("dragend",{decelerate:!0}),n._animateToPosition(n._currentTranslationX,s,a,o.ANIMATION_CURVE_EASE_OUT,function(){n._setTranslation(n._currentTranslationX,s),n._endScrollBars(),n._fireScrollEvent("scrollend",t)})}},_fireScrollEvent:function(t,e){for(var i,n=0,r=this._contentContainer,o=-this._currentTranslationY,a=this._sections,s=a._children,c=s.length,l=0;c>l;l+=2){var u=s[l],d=o-u._measuredTop,h=u._measuredHeight-d;if(d>0&&h>0)for(var _=u._rows._children,f=1;_.length>f;f+=2){var p=_[f],g=d-p._measuredTop,v=p._measuredHeight-g;g>0&&v>0&&(n++,!i&&(i=p))}}this.fireEvent(t,{contentOffset:{x:0,y:o},contentSize:{width:a._measuredWidth,height:a._measuredHeight},firstVisibleItem:i,size:{width:r._measuredWidth,height:r._measuredHeight},totalItemCount:this.data.length,visibleItemCount:n,x:e&&e.x,y:e&&e.y})},_defaultWidth:o.FILL,_defaultHeight:o.FILL,_getContentOffset:function(){return{x:-this._currentTranslationX,y:-this._currentTranslationY}},fireEvent:function(t,i){var n,r=0,o=0,a=this._sections._children,s=this._tableViewRowClicked,c=this._tableViewSectionClicked;if(u.test(t)){if(s&&c){for(;a.length>r;r+=2){if(n=a[r]._rows._children.indexOf(s),-1!==n){o+=Math.floor(n/2);break}o+=a[r].rowCount}i.row=i.rowData=s,i.index=o,i.section=c,i.searchMode=!1,e.prototype.fireEvent.apply(this,arguments),this._tableViewRowClicked=null,this._tableViewSectionClicked=null}}else e.prototype.fireEvent.apply(this,arguments)},_createSeparator:function(){var t=o.createView({height:1,width:o.INHERIT,backgroundColor:"white"});return a(t.domNode,"minWidth","100%"),t},_createDecorationLabel:function(t){return o.createLabel({text:t,backgroundColor:"darkGrey",color:"white",width:o.INHERIT,height:o.SIZE,left:0,font:{fontSize:22}})},_refreshSections:function(){for(var t=0;this._sections._children.length>t;t+=2)this._sections._children[t]._refreshRows();this._triggerLayout()},_calculateLocation:function(t){for(var e,i=0,n=0;this._sections._children.length>n;n+=2)if(e=this._sections._children[n],i+=e.rowCount,i>t)return{section:e,localIndex:e.rowCount-(i-t)};return t==i?{section:e,localIndex:e.rowCount}:void 0},_insertRow:function(t,e){var i=this._calculateLocation(e);i&&i.section.add(t,i.localIndex),this._publish(t),this._refreshSections()},_removeRow:function(t){var e=this._calculateLocation(t);e&&(this._unpublish(e.section._rows._children[2*e.localIndex+1]),e.section._removeAt(e.localIndex))},appendRow:function(t){this._currentSection||(this._sections._add(this._currentSection=o.createTableViewSection({_tableView:this})),this.sections.push(this._currentSection),this._sections._add(this._createSeparator()),this.data.push(this._currentSection)),this._currentSection.add(t),this._publish(t),this._refreshSections()},deleteRow:function(t){this._removeRow(t)},insertRowAfter:function(t,e){this._insertRow(e,t+1)},insertRowBefore:function(t,e){this._insertRow(e,t)},updateRow:function(t,e){this._removeRow(t),this._insertRow(e,t)},scrollToIndex:function(t){var e=this._calculateLocation(t);e&&this._setTranslation(0,-e.section._measuredTop-e.section._rows._children[2*e.localIndex+1]._measuredTop)},scrollToTop:function(t){this._setTranslation(0,-t)},_insertSection:function(t,e){!s(t,"Array")&&(t=[t]);for(var i=0,n=t.length;n>i;i++)c(t[i].declaredClass)&&"Ti.UI.TableViewSection"==t[i].declaredClass||(t[i]=o.createTableViewSection(t[i])),this._sections._insertAt(t[i],e+i),e===n?this.sections.push(t[i]):this.sections.splice(e,0,t[i]);this._refreshSections()},_removeSection:function(t){this._sections._remove(this.sections[t]),this.sections.splice(t,1)},appendSection:function(t){this._insertSection(t,this.sections.length)},deleteSection:function(t){t in this.sections&&(this._sections._remove(this.sections[t]),this.sections.splice(t,1))},insertSectionBefore:function(t,e){this._insertSection(e,t)},insertSectionAfter:function(t,e){this._insertSection(e,t+1)},updateSection:function(t,e){this._removeSection(t),this._insertSection(e,t)},constants:{sectionCount:{get:function(){return this.sections.length}},sections:void 0},properties:{data:{set:function(t){if(s(t,"Array")){var e,i=[];this._sections._removeAllChildren(),this.constants.__values__.sections=[],this._currentSection=void 0;for(e in t)(!c(t[e].declaredClass)||"Ti.UI.TableViewRow"!=t[e].declaredClass&&"Ti.UI.TableViewSection"!=t[e].declaredClass)&&(t[e]=o.createTableViewRow(t[e]));for(e=0;t.length>e;e++)"Ti.UI.TableViewRow"===t[e].declaredClass?(this._currentSection||(this.appendSection(this._currentSection=o.createTableViewSection({_tableView:this})),i.push(this._currentSection)),this._currentSection.add(t[e])):"Ti.UI.TableViewSection"===t[e].declaredClass&&(t[e]._tableView=this,this.appendSection(this._currentSection=t[e]),i.push(this._currentSection)),this._publish(t[e]);return this._refreshSections(),i}}},footerTitle:{set:function(t,e){return e!=t&&(this._footer._removeAllChildren(),this._footer._add(this._createDecorationLabel(t))),t}},footerView:{set:function(t,e){return e!=t&&(this._footer._removeAllChildren(),this._footer._add(t)),t}},headerTitle:{set:function(t,e){return e!=t&&(this._header._removeAllChildren(),this._header._add(this._createDecorationLabel(t)),this._header._add(this._createSeparator())),t}},headerView:{set:function(t,e){return e!=t&&(this._header._removeAllChildren(),this._header._add(t)),t}},maxRowHeight:{post:"_refreshSections"},minRowHeight:{post:"_refreshSections"},rowHeight:{post:"_refreshSections",value:"50px"},separatorColor:{post:"_refreshSections",value:"lightGrey"},separatorStyle:{post:"_refreshSections",value:r.SINGLE_LINE}}})});