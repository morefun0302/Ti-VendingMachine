define(["Ti/_/browser","Ti/_/declare","Ti/UI/View","Ti/_/lang","Ti/_/dom","Ti/_/style","Ti/UI","Ti/_/event"],function(t,e,i,n,o,r,a){var s=(r.set,o.unitize),l=o.calculateDistance,c=require.on,u=100,d=100;return e("Ti._.UI.KineticScrollView",i,{_initKineticScrollView:function(t,e,i,n){function o(){m=Date.now(),v=m-p,p=m,y++?(w=(w*(y-1)+y*(h-T)/v)/2/y,I=(I*(y-1)+y*(_-b)/v)/2/y):(w=(h-u)/v,I=(_-d)/v)}function r(){f=x._minTranslationX=Math.min(0,x._measuredWidth-x._borderLeftWidth-x._borderRightWidth-x._contentContainer._measuredWidth),g=x._minTranslationY=Math.min(0,x._measuredHeight-x._borderTopWidth-x._borderBottomWidth-x._contentContainer._measuredHeight)}var s,u,d,h,_,f,g,p,m,v,T,b,y,w,I,E,x=this;x._currentTranslationX=0,x._currentTranslationY=0,x._horizontalElastic="horizontal"===e||"both"===e,x._verticalElastic="vertical"===e||"both"===e,x._kineticTransform=a.create2DMatrix(),("horizontal"===i||"both"===i)&&x._createHorizontalScrollBar(),("vertical"===i||"both"===i)&&x._createVerticalScrollBar(),x._add(x._contentContainer=t),s=t.domNode,c(x._contentContainer,"postlayout",function(){r(),x._setTranslation(x._currentTranslationX,x._currentTranslationY)}),c(x,"draggingstart",function(e){if(x.scrollingEnabled){x._cancelAnimations(),w=void 0,I=void 0,u=x._currentTranslationX,d=x._currentTranslationY,y=0,p=(new Date).getTime(),r();var i=x._measuredWidth,n=x._measuredHeight,o=t._measuredWidth,a=t._measuredHeight;x._startScrollBars({x:-x._currentTranslationX/(o-i),y:-x._currentTranslationY/(a-n)},{x:i/o,y:n/a}),x._handleDragStart&&x._handleDragStart(e)}}),c(x,"dragging",function(t){x.scrollingEnabled&&(h=u+t.distanceX,_=d+t.distanceY,o(),x._setTranslation(T=h,b=_),x._handleDrag&&x._handleDrag(t))}),c(x,"draggingcancel",function(t){x.scrollingEnabled&&(x._animateToPosition(u,d,400+.3*l(u,d,x._currentTranslationX,x._currentTranslationY),a.ANIMATION_CURVE_EASE_IN_OUT,function(){x._handleDragCancel&&x._handleDragCancel(t)}),x._endScrollBars(),x._handleDragCancel&&x._handleDragCancel(t))}),c(x,"draggingend",function(t){if(x.scrollingEnabled){h=u+t.distanceX,_=d+t.distanceY,o();var e,i=x._currentTranslationX,n=x._currentTranslationY;i>0?(i=0,e=1):f>i&&(i=f,e=1),n>0?(n=0,e=1):g>n&&(n=g,e=1),e?x._animateToPosition(i,n,200,a.ANIMATION_CURVE_EASE_OUT,function(){x._handleDragEnd&&x._handleDragEnd(t),x._endScrollBars()}):x._handleDragEnd&&x._handleDragEnd(t,w,I)}}),n&&(this._disconnectMouseWheelEvent=c(x.domNode,"mousewheel",function(e){if(x.scrollingEnabled){x._cancelAnimations();var i=t._measuredWidth-x._measuredWidth,n=t._measuredHeight-x._measuredHeight,o=-x._currentTranslationX,a=-x._currentTranslationY;r(),x._startScrollBars({x:o/i,y:a/n},{x:x._measuredWidth/t._measuredWidth,y:x._measuredHeight/t._measuredHeight}),x._setTranslation(Math.min(0,Math.max(x._minTranslationX,-o+e.wheelDeltaX)),Math.min(0,Math.max(x._minTranslationY,-a+e.wheelDeltaY))),clearTimeout(E),E=setTimeout(function(){x._endScrollBars()},500),x._handleMouseWheel&&x._handleMouseWheel()}}))},destroy:function(){this._disconnectMouseWheelEvent&&this._disconnectMouseWheelEvent(),i.prototype.destroy.apply(this,arguments)},_animateToPosition:function(t,e,i,n,o){var r,a=this,s=a._contentContainer,c=(s.domNode,a._horizontalScrollBar),u=a._verticalScrollBar;1>l(a._currentTranslationX,a._currentTranslationY,t,e)?(a._setTranslation(t,e),o()):(r=a._setTranslation(t,e,1),a._contentAnimation=s.animate({transform:a._kineticTransform.translate(r.translationX,r.translationY),duration:Math.round(i),curve:n},o),a._horizontalScrollBarAnimation=c&&c.animate({transform:this._kineticTransform.translate(Math.max(0,Math.min(1,-r.translationX/(s._measuredWidth-a._measuredWidth)))*(this._measuredWidth-this._scrollBarWidth),0),duration:i,curve:n}),a._verticalScrollBarAnimation=u&&u.animate({transform:this._kineticTransform.translate(0,Math.max(0,Math.min(1,-r.translationY/(s._measuredHeight-a._measuredHeight)))*(this._measuredHeight-this._scrollBarHeight)),duration:i,curve:n}))},_setTranslation:function(t,e,i){function n(t){return u*(-1/(t/d+1)+1)}var o=this._contentContainer,r=this._minTranslationX,a=this._minTranslationY,s=this._horizontalElastic&&!this.disableBounce&&this._measuredWidth<o._measuredWidth,l=this._verticalElastic&&!this.disableBounce&&this._measuredHeight<o._measuredHeight,c=this._measuredWidth,h=this._measuredHeight,_=o._measuredWidth,f=o._measuredHeight;if(t>0?t=s?n(t):0:r>t&&(t=s?r-n(r-t):r),e>0?e=l?n(e):0:a>e&&(e=l?a-n(a-e):a),i||this._contentContainer.animate({transform:this._kineticTransform.translate(this._currentTranslationX=t,this._currentTranslationY=e)}),this._isScrollBarActive){var g=this._horizontalScrollBar,p=this._verticalScrollBar;g&&g.animate({transform:this._kineticTransform.translate(Math.max(0,Math.min(1,-t/(_-c)))*(this._measuredWidth-this._scrollBarWidth),0)}),p&&p.animate({transform:this._kineticTransform.translate(0,Math.max(0,Math.min(1,-e/(f-h)))*(this._measuredHeight-this._scrollBarHeight))})}return{translationX:t,translationY:e}},_cancelAnimations:function(){this._horizontalScrollBarAnimation&&this._horizontalScrollBarAnimation.cancel(),this._verticalScrollBarAnimation&&this._verticalScrollBarAnimation.cancel(),this._contentAnimation&&this._contentAnimation.cancel()},_createHorizontalScrollBar:function(){this._horizontalScrollBar||this._add(this._horizontalScrollBar=a.createView({zIndex:2147483647,backgroundColor:"#555",borderRadius:3,width:0,height:6,left:0,bottom:0,opacity:0}))},_createVerticalScrollBar:function(){this._verticalScrollBar||this._add(this._verticalScrollBar=a.createView({zIndex:2147483647,backgroundColor:"#555",borderRadius:3,width:6,height:0,right:0,top:0,opacity:0}))},_destroyHorizontalScrollBar:function(){this._horizontalScrollBarAnimation&&this._horizontalScrollBarAnimation.cancel(),this._remove(this._horizontalScrollBar)},_destroyVerticalScrollBar:function(){this._verticalScrollBarAnimation&&this._verticalScrollBarAnimation.cancel(),this._remove(this._verticalScrollBar)},_startScrollBars:function(t,e){if(this._horizontalScrollBar&&1>e.x&&e.x>0){var i=this._measuredWidth,n=this._scrollBarWidth=Math.round(Math.max(10,i*e.x)),o=this._horizontalScrollBar;o.opacity=.5,o.domNode.style.width=s(n),o.animate({transform:this._kineticTransform.translate(Math.max(0,Math.min(1,t.x))*(i-n),0)}),this._isScrollBarActive=1}if(this._verticalScrollBar&&1>e.y&&e.y>0){var r=this._measuredHeight,a=this._scrollBarHeight=Math.round(Math.max(10,r*e.y)),l=this._verticalScrollBar;l.opacity=.5,l.domNode.style.height=s(a),l.animate({transform:this._kineticTransform.translate(0,Math.max(0,Math.min(1,t.y))*(r-a))}),this._isScrollBarActive=1}},_endScrollBars:function(){function t(t){t&&t.animate({opacity:0,duration:500},function(){e._isScrollBarActive=!1})}if(this._isScrollBarActive){var e=this,i=e._horizontalScrollBar,n=e._verticalScrollBar;t(i),t(n)}},properties:{scrollingEnabled:!0}})});