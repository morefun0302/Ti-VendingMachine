define(["Ti/_/Layouts/Base","Ti/_/declare","Ti/UI","Ti/_/lang"],function(t,e,i,n){var r=n.isDef,o="px",a=Math.round;return e("Ti._.Layouts.Composite",t,{_doLayout:function(t,e,n,r,s){var c,l,u,d,h,_,f,p,g,v,m,T,y,w,b,I,E,S,C={width:0,height:0},A=t._children,N=0,x=[],L=[],O=A.length,k=this._measureNode;for(N=0;O>N;N++)c=t._children[N],c._alive&&c.domNode?(c._markedForLayout&&((c._preLayout&&c._preLayout(e,n,r,s)||c._needsMeasuring)&&k(c,c,c._layoutCoefficients,this),l=c._layoutCoefficients,u=l.width,g=l.minWidth,d=l.height,v=l.minHeight,h=l.sandboxWidth,_=l.sandboxHeight,p=l.left,f=l.top,T=u.x1*e+u.x2,void 0!==g.x1&&(T=Math.max(T,g.x1*e+g.x2)),y=d.x1*n+d.x2,void 0!==v.x1&&(y=Math.max(y,v.x1*n+v.x2)),m=c._getContentSize?c._getContentSize(T,y):c._layout._doLayout(c,isNaN(T)?e:T-c._borderLeftWidth-c._borderRightWidth,isNaN(y)?n:y-c._borderTopWidth-c._borderBottomWidth,isNaN(T),isNaN(y)),isNaN(T)&&(T=m.width+c._borderLeftWidth+c._borderRightWidth,void 0!==g.x1&&(T=Math.max(T,g.x1*e+g.x2))),isNaN(y)&&(y=m.height+c._borderTopWidth+c._borderBottomWidth,void 0!==v.x1&&(y=Math.max(y,v.x1*n+v.x2))),r&&0!==p.x1?x.push(c):I=p.x1*e+p.x2*T+p.x3,s&&0!==f.x1?L.push(c):E=f.x1*n+f.x2*y+f.x3,c._measuredSandboxWidth=b=h.x1*n+h.x2+T+(isNaN(I)?0:I),c._measuredSandboxHeight=w=_.x1*n+_.x2+y+(isNaN(E)?0:E),c._measuredWidth=T,c._measuredHeight=y,c._measuredLeft=I,c._measuredTop=E),c._measuredSandboxWidth>C.width&&(C.width=c._measuredSandboxWidth),c._measuredSandboxHeight>C.height&&(C.height=c._measuredSandboxHeight)):this.handleInvalidState(c,t);for(O=x.length,N=0;O>N;N++)c=x[N],p=c._layoutCoefficients.left,h=c._layoutCoefficients.sandboxWidth,c._measuredLeft=I=p.x1*C.width+p.x2*T+p.x3,c._measuredSandboxWidth=b=h.x1*n+h.x2+c._measuredWidth+I,b=c._measuredSandboxWidth,b>C.width&&(C.width=b);for(O=L.length,N=0;O>N;N++)c=L[N],f=c._layoutCoefficients.top,_=c._layoutCoefficients.sandboxHeight,c._measuredTop=E=f.x1*C.height+f.x2*y+f.x3,c._measuredSandboxHeight=w=_.x1*n+_.x2+c._measuredHeight+E,w=c._measuredSandboxHeight,w>C.height&&(C.height=w);for(O=A.length,N=0;O>N;N++)c=A[N],c._markedForLayout&&(i._elementLayoutCount++,S=c.domNode.style,S.zIndex=c.zIndex,S.left=a(c._measuredLeft)+o,S.top=a(c._measuredTop)+o,S.width=a(c._measuredWidth-c._borderLeftWidth-c._borderRightWidth)+o,S.height=a(c._measuredHeight-c._borderTopWidth-c._borderBottomWidth)+o,c._markedForLayout=!1,c.fireEvent("postlayout"));return this._computedSize=C},_getWidth:function(t,e){return!r(e)&&2>r(t.left)+r(t.center&&t.center.x)+r(t.right)&&(e=t._defaultWidth),e===i.INHERIT?t._parent._parent?t._parent._parent._layout._getWidth(t._parent,t._parent.width)===i.SIZE?i.SIZE:i.FILL:i.FILL:e},_getHeight:function(t,e){return!r(e)&&2>r(t.top)+r(t.center&&t.center.y)+r(t.bottom)&&(e=t._defaultHeight),e===i.INHERIT?t._parent._parent?t._parent._parent._layout._getHeight(t._parent,t._parent.height)===i.SIZE?i.SIZE:i.FILL:i.FILL:e},_isDependentOnParent:function(t){var e=t._layoutCoefficients;return!isNaN(e.width.x1)&&0!==e.width.x1||!isNaN(e.height.x1)&&0!==e.height.x1||0!==e.left.x1||0!==e.top.x1},_doAnimationLayout:function(t,e){var i=t._parent._measuredWidth,n=t._parent._measuredHeight,r=e.width.x1*i+e.width.x2,o=e.height.x1*n+e.height.x2;return{width:r,height:o,left:e.left.x1*i+e.left.x2*r+e.left.x3,top:e.top.x1*n+e.top.x2*o+e.top.x3}},_measureNode:function(t,e,n,r){t._needsMeasuring=!1;for(var o,a,s,c,l,u,d,h,_,f,p,g,v,m=r.getValueType,T=r.computeValue,y=r._getWidth(t,e.width),w=m(y),b=T(y,w),I=e._minWidth,E=m(I),S=T(I,E),C=r._getHeight(t,e.height),A=m(C),N=T(C,A),x=e._minHeight,L=m(x),O=T(x,L),k=e.left,R=m(k),D=T(k,R),U=e.center&&e.center.x,P=m(U),M=T(U,P),B=e.right,V=m(B),F=T(B,V),W=e.top,H=m(W),G=T(W,H),Y=e.center&&e.center.y,q=m(Y),j=T(Y,q),z=e.bottom,Z=m(z),X=T(z,Z),K=n.sandboxWidth,$=n.sandboxHeight,J=[[w,b,R,D,P,M,V,F],[A,N,H,G,q,j,Z,X]],Q=0;2>Q;Q++)c=J[Q],l=c[0],u=c[1],d=c[2],h=c[3],_=c[4],f=c[5],p=c[6],g=c[7],o=a=0,l===i.SIZE?o=a=0/0:l===i.FILL?(o=1,"%"===d?o-=h:"#"===d?a=-h:"%"===p?o-=g:"#"===p&&(a=-g)):"%"===l?o=u:"#"===l?a=u:"%"===d?"%"===_?o=2*(f-h):"#"===_?(o=-2*h,a=2*f):"%"===p?o=1-h-g:"#"===p&&(o=1-h,a=-g):"#"===d?"%"===_?(o=2*f,a=-2*h):"#"===_?a=2*(f-h):"%"===p?(o=1-g,a=-h):"#"===p&&(o=1,a=-g-h):"%"===_?"%"===p?o=2*(g-f):"#"===p&&(o=-2*f,a=2*g):"#"===_&&("%"===p?(o=2*g,a=-2*f):"#"===p&&(a=2*(g-f))),n[v=0===Q?"width":"height"].x1=o,n[v].x2=a;J={minWidth:[E,S,R,D,P,M,V,F],minHeight:[L,O,H,G,q,j,Z,X]};for(Q in J)c=J[Q],l=c[0],u=c[1],d=c[2],h=c[3],_=c[4],f=c[5],p=c[6],g=c[7],o=a=s=0,l===i.SIZE?o=a=0/0:l===i.FILL?(o=1,"%"===d?o-=h:"#"===d?a=-h:"%"===p?o-=g:"#"===p&&(a=-g)):"%"===l?o=u:"#"===l?a=u:o=a=s=void 0,n[Q].x1=o,n[Q].x2=a,n[Q].x3=s;for(J=[[R,D,P,M,V,F],[H,G,q,j,Z,X]],Q=0;2>Q;Q++){if(c=J[Q],d=c[0],h=c[1],_=c[2],f=c[3],p=c[4],g=c[5],o=a=s=0,"%"===d)o=h;else if("#"===d)s=h;else if("%"===_)o=f,a=-.5;else if("#"===_)a=-.5,s=f;else if("%"===p)o=1-g,a=-1;else if("#"===p)o=1,a=-1,s=-g;else switch("left"===Q?r._defaultHorizontalAlignment:r._defaultVerticalAlignment){case"center":o=.5,a=-.5;break;case"end":o=1,a=-1}n[v=0===Q?"left":"top"].x1=o,n[v].x2=a,n[v].x3=s}K.x1="%"===V?F:0,K.x2="#"===V?F:0,$.x1="%"===Z?X:0,$.x2="#"===Z?X:0},_defaultHorizontalAlignment:"center",_defaultVerticalAlignment:"center"})});