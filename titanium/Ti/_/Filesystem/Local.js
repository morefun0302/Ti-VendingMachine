define(["Ti/_","Ti/_/declare","Ti/_/encoding","Ti/_/lang","Ti/API","Ti/Blob"],function(t,e,i,n,r,o){function a(t,e){return I.getItem("ti:fs:"+(e?"meta:":"blob:")+t)}function s(t,e,i){return I.setItem("ti:fs:"+(i?"meta:":"blob:")+t,e),e.length}function c(t){var e=new XMLHttpRequest;return e.overrideMimeType("text/plain; charset=x-user-defined"),e.open("GET","."+t,!1),e.send(null),200===e.status?{data:e.responseText,mimeType:e.getResponseHeader("Content-Type")}:null}function l(t){var e,i=[];return p||(p={"/":"tD\nr1"},require("./titanium/filesystem.registry").split(/\n|\|/).forEach(function(t,e){var n,r=0,t=t.split("	"),o=t.length;if(0===e&&"ts"===t[0])m=t[1],p[y]+="\nc"+m;else{for(;o>r&&!t[r];r++);i=i.slice(0,r).concat(n=t[r]),p[y+i.join(y)]="n"+n+"\nt"+(r+1==o?"D":"F\ns"+t[r+1])}})),(e=p[t])&&e+"\nr1\ne1\nc"+m+"\nm"+m}function u(){return v||(v=require("Ti/Filesystem"))}function d(t,e,i,n){var o,i=i||1,a=t+e.slice(0,i).join(y);return n&&n.readonly?(r.error('Unable to create "'+a+'" because parent is readonly'),!1):(o=new g({nativePath:a,type:"D"}),o.createDirectory(),++i>e.length?!0:d(t,e,i,o))}function h(t){if(t){var e=t.match(C),i=(e[1]?e[1]:e[2]+e[3])||y;return t=e[1]?e[2]:e[4],t?d(i,t.split(y)):!0}return!1}function _(t,e){var i,n,r=t.nativePath,o=RegExp("^(ti:fs:meta|ti:fs:blob):"+r+(/\/$/.test(r)?"":y)+"(.*)"),a=0,s=I.length;if(e=u().getFile(e.nativePath,t.name),h(e.nativePath)){for(;s>a;)n=I.key(a++),(i=n.match(o))&&I.setItem(i[1]+":"+e.nativePath+y+i[2],I.getItem(n)||"");return!0}return!1}function f(){for(var t,e=/^ti:fs:tmp:\/\//,i=0,n=I.length;n>i;)t=I.key(i++),e.test(t)&&I.removeItem(t)}var p,g,v,m=Date.now(),T=require.is,I=localStorage,y="/",w={n:"sname",c:"i_created",m:"i_modified",t:"s_type",y:"s_mimeType",e:"b_remote",x:"bexecutable",r:"breadonly",s:"isize",l:"bsymbolicLink",h:"bhidden"},b={i:function(t){return t-0},s:function(t){return""+t},b:function(t){return!!(0|t)}},E="ti:fs:meta:",S="ti:fs:blob:",C=/(\/)?([^\:]*)(\:\/\/)?(.*)/,A="application/octet-stream,text/plain,text/html,text/css,text/xml,text/mathml,image/gif,image/jpeg,image/png,image/x-icon,image/svg+xml,application/x-javascript,application/json,application/pdf,application/x-opentype,audio/mpeg,video/mpeg,video/quicktime,video/x-flv,video/x-ms-wmv,video/x-msvideo,video/ogg,video/mp4,video/webm,text/csv".split(","),N={txt:1,html:2,htm:2,css:3,xml:4,mml:5,gif:6,jpeg:7,jpg:7,png:8,ico:9,svg:10,js:11,json:12,pdf:13,otf:14,mp3:15,mpeg:16,mpg:16,mov:17,flv:18,wmv:19,avi:20,ogg:21,ogv:21,mp4:22,m4v:22,webm:23,csv:24};return f(),require.on(window,"beforeunload",f),function(t,e){for(var i in t)a(i,1)||s(i,"c"+e+"\nm"+e+"\ntD\ne0\nx0\nl0\nh0\nr"+t[i],1)}({"appdata://":0,"/":1,"tmp://":0},Date.now()),g=e("Ti._.Filesystem.Local",null,{constructor:function(t){if(T(t,"String")){var e=t.match(C),i=!e[1]&&e[3];if(/^\.\./.test(t=i?e[4]:e[2]))throw Error('Irrational path "'+t+'"');this.constants.__values__.nativePath=(i?e[2]+"://":y)+t}this._type=t&&"D"!==t._type?"F":"D"},postscript:function(){var t,e,i=this.constants,n=this.nativePath,r=n&&a(n,1)||l(n),o=n.match(C),s=(o[1]?o[1]:o[2]+o[3])||y;r&&(this._exists=1)&&r.split("\n").forEach(function(t){var e=w[t.charAt(0)],n=e.substring(1),r=b[e.charAt(0)](t.substring(1));(i.hasOwnProperty(n)?i.__values__:this)[n]=r},this),n=o[1]?o[2]:o[4],t=n.split(y),i.name=t.pop(),t=t.join(y),e=i.parent=n?new g(s+t):null,e&&e.readonly||o&&o[1]&&(i.readonly=!0)},constants:{name:"",executable:!1,readonly:!1,size:0,symbolicLink:!1,nativePath:"",parent:null,writable:{get:function(){return!this.readonly},set:function(t){return this.constants.__value__.readonly=!t},value:!0}},properties:{hidden:!1},append:function(t){if(this.isFile()){switch(t&&t.declaredClass){case"Ti.Filesystem.File":t=t.read();case"Ti.Blob":this._mimeType=t.mimeType,t=t.text}var e=this.read();return e.append(t),this.write(e)}return!1},copy:function(t){if(this.exists&&t){var e=u(),t="Ti.Filesystem.File"===t.declaredClass?t:e.getFile.apply(null,arguments),i=t.parent,n=this.isFile();return t.exists()?t.readonly?!1:t.isFile()?n?t.write(this.read()):(Ti.API.error("Destination is not a directory"),!1):n?e.getFile(t.nativePath,this.name).write(this.read()):_(this,t):i&&(i.createDirectory(),!i.exists()||i.readonly||!n&&!t.createDirectory())?!1:n?t.write(this.read()):_(this,t)}return!1},createDirectory:function(){return this._create("D")},createFile:function(){return this._create("F")},createTimestamp:function(){return this._created||null},deleteDirectory:function(t){if(this.isDirectory()&&!this.readonly){for(var e=this.nativePath,i=RegExp("^ti:fs:(meta|blob):"+e+(/\/$/.test(e)?"":y)+".*"),n=0,r=I.length;r>n;)if(i.test(key=I.key(n++))){if(!t)return Ti.API.error('Directory "'+e+'" not empty'),!1;I.removeItem(key)}return this._exists=0,I.removeItem(E+e),I.removeItem(S+e),!0}return!1},deleteFile:function(){if(this.exists()&&this.isFile()&&!this.readonly){var t=this.nativePath;return this._exists=0,I.removeItem(E+t),I.removeItem(S+t),!0}return!1},exists:function(){return!!this._exists},extension:function(){var t=this.name.match(/\.(.+)$/);return t?t[1]:""},getDirectoryListing:function(){function t(t,i){var n,r=t.match(i);r&&r[1]&&0>e.indexOf(n=r[1].split(y)[0])&&e.push(n)}var e=[];if(this.isDirectory()){for(var i=this.nativePath+(/\/$/.test(this.nativePath)?"":y),n=RegExp("^"+E+i+"(.*)"),r=RegExp("^"+i+"(.*)"),o=0,a=I.length;a>o;)t(I.key(o++),n);for(o in p)t(o,r)}return e.sort()},isDirectory:function(){return"D"===this._type},isFile:function(){return"F"===this._type},modificationTimestamp:function(){return this._modified||null},move:function(){return this.copy.apply(this,arguments)&&this[this.isFile()?"deleteFile":"deleteDirectory"](1)},open:function(t){var e=require("Ti/Filesystem/FileStream");return this.exists()&&this.isFile()?new e({mode:t,data:this.read().text}):null},read:function(){if(this.exists()&&this.isFile()){var e,i=this.nativePath,n=this._remote?(e=c(i)).data:a(i)||"",r=A[N[this.extension()]||0],s=e&&e.mimeType||this._mimeType||r,l=0,u=n.length,d="",h={file:this,data:n,length:u,mimeType:s="application/octet-stream"===s&&s!==r?r:s,nativePath:i};if(this._remote&&t.isBinaryMimeType(s)){for(;u>l;)d+=String.fromCharCode(255&n.charCodeAt(l++));h.data=btoa(d)}return new o(h)}return null},rename:function(t){if(this.exists&&!this.readonly){var e,i,n=this.nativePath,r=n,o=I.getItem(S+r),a=RegExp("^ti:fs:(meta|blob):"+r+(/\/$/.test(r)?"":y)+"(.*)"),s=r.match(C),c=(s[1]?s[1]:s[2]+s[3])||y,l=0,u=I.length;if(this.constants.__values__,r=s[1]?s[2]:s[4],!r)return Ti.API.error("Can't rename root \""+c+'"'),!1;if(r=r.split(y),r.pop(),r.push(t),e=new g(r=c+r.join(y)),e.exists()||e.parent.readonly)return!1;if("D"===this._type)for(;u>l;)i=I.key(l++),(s=i.match(a))&&(I.setItem("ti:fs:"+s[1]+":"+r+y+s[2],I.getItem(i)),I.removeItem(i));return this._save(r,t),o&&I.setItem(S+r,o),I.removeItem(E+n),I.removeItem(S+n),!0}return!1},resolve:function(){return this.nativePath},spaceAvailable:function(){return"remainingSpace"in I?I.remainingSpace:null},write:function(t,e){var i=this.nativePath;if(i&&this.isFile()&&!this.readonly&&this.parent&&!this.parent.readonly){switch(t&&T(t,"String")&&(this._mimeType=A[1]),t&&t.declaredClass){case"Ti.Filesystem.File":t=t.read();case"Ti.Blob":this._mimeType=t.mimeType,t=t._data||""}return this._exists=1,this._modified=Date.now(),this._created||(this._created=this._modified),this.constants.__values__.size=s(i,e?this.read()+t:t),this._save()}return!1},_create:function(t){return!this.exists()&&this.parent&&!this.parent.readonly&&h(this.parent.nativePath)?(this._created=this._modified=Date.now(),this._exists=1,this._type=t,this._save()):!1},_save:function(t,e){var i,t=t||this.nativePath;return t?(i=["n",e||this.name,"\nc",this._created,"\nm",this._modified,"\nt",this._type,"\ne0\nx0\nr",0|this.readonly,"\nl",0|this.symbolicLink,"\nh",0|this.hidden],"F"===this._type&&i.push("\ns"+this.size),this._mimeType&&i.push("\ny"+this._mimeType),s(t,i.join(""),1),!0):!1}})});