define(["Ti/_/declare","Ti/_/dom","Ti/_/event","Ti/_/lang","Ti/App/Properties","Ti/Geolocation","Ti/Map","Ti/UI/View","Ti/Utils"],function(t,e,i,n,o,r,a,s,l){function c(t){var e=u.MapTypeId;switch(t){case a.HYBRID_TYPE:return e.HYBRID;case a.SATELLITE_TYPE:return e.SATELLITE;case a.TERRAIN_TYPE:return e.TERRAIN}return e.ROADMAP}var u,d,h,_,f=n.isDef,p=require.mix,g=require.on,m=s.prototype.fireEvent,v={latitude:39.828175,longitude:-98.5795,latitudeDelta:30.137412,longitudeDelta:63.235658},T={0:"red",1:"green",2:"purple"},y=Ti.deferStart(),b=t("Ti.Map.View",s,{constructor:function(){this.properties.__values__.annotations=[],this._annotationMap={},this._routes=[],this.fireEvent("loading")},postscript:function(){var t=this,e=t.region||v,i=t._gmap=new u.Map(t.domNode,{disableDefaultUI:!0,zoom:2,zoomControl:!0,center:new u.LatLng(e.latitude,e.longitude),mapTypeId:c(t.mapType)});g(t,"postlayout",function(){d.trigger(i,"resize"),t._updateMap(e,1),setTimeout(function(){t._updateMap(e,1),t._updateUserLocation(t.userLocation),t.annotations.forEach(t._createMarker,t),t._annotationEvents=[],t._boundsEvt=d.addListener(i,"bounds_changed",n.hitch(t,"_fitRegion"))},1)})},destroy:function(){i.off(this._annotationEvents),d.removeListener(this._boundsEvt),d.clearInstanceListeners(this._gmap),this.removeAllAnnotations(),this._gmap=null,s.prototype.destroy.apply(this,arguments)},addAnnotation:function(t){t&&("Ti.Map.Annotation"===t.declaredClass||(t=new Annotation(t)),~this.annotations.indexOf(t)||this._createMarker(t),t.title&&(this._annotationMap[t.title]=t))},addAnnotations:function(t){t&&t.forEach(this.addAnnotation,this)},addRoute:function(t){t&&(t.points||[]).length&&(t.pline=new u.Polyline({map:this._gmap,path:t.points.map(function(t){return new u.LatLng(t.latitude,t.longitude)}),strokeColor:t.color||"#000",strokeWeight:t.width||1}),this._routes.push(t))},deselectAnnotation:function(t){require.is(t,"String")&&(t=this._annotationMap[t]),t&&h&&h.widgetId===t.widgetId&&this._hide(t)},removeAllAnnotations:function(){for(h&&h.close();this.annotations.length;)this.removeAnnotation(this.annotations[0])},removeAnnotation:function(t){if(require.is(t,"String")&&(t=this._annotationMap[t]),t){var e=this.properties.__values__.annotations,i=e.indexOf(t);h&&this._hide(t),d.removeListener(t.evt),t.marker.setMap(null),delete t.marker,t.destroy(),~i&&e.splice(i,1)}},removeAnnotations:function(t){t.forEach(function(t){this.removeAnnotation(t)},this)},removeRoute:function(t){if(t&&t.name)for(var e=this._routes,i=0;e.length>i;i++)e[i].name===t.name&&(t.pline.setMap(null),delete t.pline,e.splice(i--,1))},selectAnnotation:function(t){require.is(t,"String")&&(t=this._annotationMap[t]),t&&this._show(t)},setLocation:function(t){t&&(this.region=t),f(t.animate)&&(this.animated=t.animate),f(t.animated)&&(this.animated=t.animated),f(t.regionFit)&&(this.regionFit=t.regionFit),this._updateMap(t)},zoom:function(t){var e=this._gmap;e.setZoom(e.getZoom()+t)},_show:function(t,n){function o(){a||(a=1)&&s._dispatchEvents(t,n)}if(t&&(!h||h.widgetId!==t.widgetId)){var r,a,s=this,l=t.widgetId,c="TiMapAnnotation",_=e.create("div",{className:c}),f=_,p={annotation:f,leftButton:t.leftButton&&e.create("img",{className:c+"LeftButton",src:t.leftButton},_),rightButton:t.rightButton&&e.create("img",{className:c+"RightButton",src:t.rightButton},_),dummy:(_=e.create("div",{className:c+"Content"},_))&&0,title:e.create("h1",{innerHTML:t._getTitle()},_),subtitle:e.create("p",{innerHTML:t._getSubtitle()},_)};i.off(s._annotationEvents);for(r in p)(function(e,n){n&&s._annotationEvents.push(g(n,"click",function(n){i.stop(n),s._hide(t,e)}))})(r,p[r]);s._annotationEvents.push(g(t,"update",this,function(e){if(h.widgetId===l){var i,n=e.property,o=e.value,r=this._annotationMap;switch(n){case"title":case"subtitle":p[n].innerHTML=o,delete r[e.oldValue],o&&(r[o]=t);break;case"leftButton":case"rightButton":p[n].src=o;break;case"image":case"pincolor":i=s._getMarkerImage(t),t.marker.setIcon(i[0]),t.marker.setShadow(i[1]||null)}}})),h?(o(),h.setContent(f)):(h=new u.InfoWindow({content:f}),d.addListener(h,"domready",o),d.addListener(h,"closeclick",function(){s._hide(t,"annotation")})),h.open(s._gmap,t.marker),h.widgetId=t.widgetId}},_hide:function(t,e){e&&~e.indexOf("Button")||(h.close(),h.widgetId=0),this._dispatchEvents(t,e)},_dispatchEvents:function(t,e){var i=this.annotations.indexOf(t),n={annotation:t,clicksource:e=e||"pin",index:i,latitude:t.latitude,longitude:t.longitude,map:this,subtitle:t._getSubtitle(),title:t._getTitle()};m.call(this,"singletap",n),m.call(this,"click",n),t._onclick(this,i,e)},_getMarkerImage:function(t){var e,i,n=T[0|t.pincolor];return t.image&&("Ti.Blob"===t.image.declaredClass?(n=T[e=l.md5HexDigest(i=""+t.image)],n||(n=T[e]=[new u.MarkerImage(i)])):(n=T[t.image],n||(n=T[t.image]=[new u.MarkerImage(t.image)]))),n},_createMarker:function(t){var e=this._getMarkerImage(t);t.evt=d.addListener(t.marker=new u.Marker({map:this._gmap,icon:e[0],shadow:e[1],position:new u.LatLng(t.latitude,t.longitude),optimized:!1,title:t._getTitle(),animation:t.animate&&u.Animation.DROP}),"click",n.hitch(this,function(){this[h&&h.widgetId===t.widgetId?"_hide":"_show"](t)})),this.properties.__values__.annotations.push(t)},_fitRegion:function(){var t=this.constants,e=this._gmap,i=e.getCenter(),n=e.getBounds(),o=n.getNorthEast(),r=n.getSouthWest(),a=t.latitudeDelta=o.lat()-r.lat(),s=t.longitudeDelta=o.lng()-r.lng(),l={latitude:i.lat(),longitude:i.lng(),latitudeDelta:a,longitudeDelta:s};this.regionFit&&(this.properties.__values__.region=l),this._initialized||(this._initialized=1,this.fireEvent("complete")),this.fireEvent("regionchanged",l)},_updateMap:function(t,e){var i=this._gmap;if(i){var n=!e&&this.animated,o=t.latitudeDelta/2,r=t.longitudeDelta/2;i[n?"panTo":"setCenter"](new u.LatLng(t.latitude,t.longitude)),i[n?"panToBounds":"fitBounds"](new u.LatLngBounds(new u.LatLng(t.latitude-o,t.longitude-r),new u.LatLng(t.latitude+o,t.longitude+r)))}},_updateUserLocation:function(t){var e=this._gmap;e&&(t||this._locationInited)&&(this._locationInited=1,r[t?"addEventListener":"removeEventListener"]("location",n.hitch(this,function(t){var e,i=this._locationMarker,n=t.coords,o=t.code;n?(e=new u.LatLng(n.latitude,n.longitude),i?i.setPosition(e):this._locationMarker=new u.Marker({map:this._gmap,icon:_,position:e})):"code"in t&&Ti.API.warn("Geolocation error: "+(o===r.ERROR_DENIED?"permission denied":o===r.ERROR_TIMEOUT?"timeout":o===r.ERROR_LOCATION_UNKNOWN?"position unavailable":"unknown"))})),r.locationServicesEnabled?(!t||this._locationMarker)&&this._locationMarker.setVisible(t):(Ti.API.warn("Geolocation services unavailable"),this.properties.__values__.userLocation=!1))},fireEvent:function(t){/(click|singletap)/.test(t)||s.prototype.fireEvent.apply(this,arguments)},constants:{latitudeDelta:0,longitudeDelta:0},properties:{animated:!1,annotations:{set:function(t){return t=t.filter(function(t){return t&&"Ti.Map.Annotation"===t.declaredClass}),this._gmap&&(this.removeAllAnnotations(),t.forEach(this._createMarker,this)),t}},mapType:{set:function(t){return this._gmap&&this._gmap.setMapTypeId(c(t)),t}},region:{set:function(t,e){return p({},v,e,t)},post:function(t,e){t!==e&&this._updateMap(t)},value:null},regionFit:!0,userLocation:{post:function(t){this._updateUserLocation(t)},value:!1}}});return window.TiMapViewInit=function(){function t(t,e,o){return new u.MarkerImage(i+"marker_"+t+".png",new u.Size(e,34),new n(o,0),new n(10,34))}u=google.maps,d=u.event;var e,i="themes/"+require.config.ti.theme+"/Map/",n=u.Point;for(e in T)T[e]=[t(T[e],20,0),t(T[e],37,20)];_=new u.MarkerImage(i+"location.png",new u.Size(22,22),new n(0,0),new n(11,11)),y()},require(["//maps.googleapis.com/maps/api/js?key="+o.getString("ti.map.apikey","")+"&sensor=true&callback=TiMapViewInit"],0,y),b});